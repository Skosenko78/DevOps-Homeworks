# **6.6. Troubleshooting**

# *Задача 1*
1.1. Список операций для остановки запроса пользователя:

Узнаем id запроса, который выполняется больше 3-х минут:
```
db.currentOp({"secs_running":{$gte:180}})
```
Остановим запрос пользователя, где 'opId' поле из предыдущего запроса:
```
db.killOp (<opId>)
```

1.2. Вариант решения проблемы с долгими (зависающими) запросами в MongoDB:

Для решения проблемы, возможно, потребеутеся использование профилировщика MongoDB, который позволяет находить медленные запросы. После обнаружения таких запросов можно воспользоваться командой explain(), для получения подробной информации о пути выполнения запроса.

Одним из вариантов решения может быть посторение индекса по нужному полю.


# *Задача 2*

При масштабировании сервиса до N реплик вы увидели, что:

 - сначала рост отношения записанных значений к истекшим
 - Redis блокирует операции записи

 Такое поведение связано с механизмом удаления ключей с истёкшим TTL. После масштабирования сервиса в базе стали появляться ключи с TTL истекающим в одну и ту же секунду, процент ключей с истёкшим TTL стал реже опускаться ниже 25%, что привело к повторным запускам механизма удаления и долгим блокировкам Redis.

# *Задача 3*

Ошибка 'InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... ' в MySQL связана с сетевыми проблемами или настройками. В данном случае ошибки начали возникать при росте количества записей, поэтому, скорее всего, это связано со слишком большим колчиством записей возвращаемых в ответ на запрос. Для исправления потребуется увеличить параметр net_read_timeout с 30 секунд до 60 или выше.

# *Задача 4*

После запуска PostgreSQL пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg появляется сообщение 'postmaster invoked oom-killer'.

Сообщение связано с работой системного процесса out-of-memory killer. Какой-то процесс запросил обещанную ему память, а свобоной нет. OOM-killer по определённым правилам выбирает процесс, который нужно завершить.

Проблему можно решить уменьшением параметра oom_score_adj процесса PostgreSQL. Можно установить параметр ядра vm.overcommit_memory=2, тогда ядро не будет резервировать больше памяти, чем указано в параметре overcommit_ratio. Можно попробовать увеличить файл подкачки или добавить оперативной памяти в сервер, если возможно. 